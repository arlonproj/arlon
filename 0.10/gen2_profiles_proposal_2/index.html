
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../images/favicon-32x32.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Gen2 Profiles - Proposal 2 - Arlon - GitOps-based Fleet Management for Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    

<script src="../assets/pymdownx-extras/material-extra-theme-8d50d708.js" type="text/javascript"></script>
<script src="../assets/pymdownx-extras/material-extra-3rdparty-a81e7739.js" type="text/javascript"></script>

    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Work Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../assets/pymdownx-extras/extra-3531de4046.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gen2-profiles-proposal-2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      


<header class="md-header" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label=""
  >
    <a
      href=".."
      title="Arlon - GitOps-based Fleet Management for Kubernetes"
      class="md-header__button md-logo"
      aria-label="Arlon - GitOps-based Fleet Management for Kubernetes"
    >
      
  <img src="../images/pictogram_arlon-stroke.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Arlon - GitOps-based Fleet Management for Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Gen2 Profiles - Proposal 2
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon">
          <a
            href="javascript:toggleScheme();"
            title="Light mode"
            class="light-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="Dark mode"
            class="dark-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="System preference"
            class="system-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34Z"/></svg>
          </a>
           <a
            href="javascript:toggleScheme();"
            title="Unknown scheme"
            class="unknown-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10Z"/></svg>
          </a>
      </div>
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/arlonproj/arlon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    arlonproj/arlon
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Arlon - GitOps-based Fleet Management for Kubernetes" class="md-nav__button md-logo" aria-label="Arlon - GitOps-based Fleet Management for Kubernetes" data-md-component="logo">
      
  <img src="../images/pictogram_arlon-stroke.svg" alt="logo">

    </a>
    Arlon - GitOps-based Fleet Management for Kubernetes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/arlonproj/arlon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    arlonproj/arlon
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../clustertemplate/" class="md-nav__link">
        Cluster Template
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../appprofiles/" class="md-nav__link">
        Application Profile
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        Design
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gen2_Tutorial/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" tabindex="0" aria-expanded="false">
          Developer Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dev_setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../e2e_testing/" class="md-nav__link">
        End to End Tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../docs_help/" class="md-nav__link">
        Help with MkDocs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#object-model" class="md-nav__link">
    Object model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#labeling-algorithm" class="md-nav__link">
    Labeling Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controller" class="md-nav__link">
    Controller
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-an-initial-arlon-application" class="md-nav__link">
    Creating an initial Arlon Application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-application-profiles" class="md-nav__link">
    Managing Application Profiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associating-profiles-with-arlon-clusters" class="md-nav__link">
    Associating profiles with Arlon clusters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associating-profiles-with-external-clusters-experimental-not-tested-yet" class="md-nav__link">
    Associating profiles with external clusters (experimental, not tested yet)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fully-declarative-initialization" class="md-nav__link">
    Fully declarative initialization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-overrides" class="md-nav__link">
    Application Overrides
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#issues-limitations" class="md-nav__link">
    Issues &amp; Limitations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-a-reconciliation-algorithm" class="md-nav__link">
    Appendix A: Reconciliation Algorithm
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  

  
  



<h1 id="gen2-profiles-proposal-2">Gen2 Profiles - Proposal 2<a class="headerlink" href="#gen2-profiles-proposal-2" title="Permanent link">&para;</a></h1>
<p>This is an update to the previous <a href="../gen2_profiles_proposal_1/">Proposal 1 for Gen2 Profiles</a> design.
The main change is the introduction of the new <strong>AppProfile</strong> custom resource,
which elevates profiles to first-class objects. The rest of the design
remains mostly unchanged, meaning Arlon apps are still based on ApplicationSets,
and a cluster is associated with an AppProfile by labeling it, except the
labeling is handled slightly differently (see <a href="#Labeling-Algorithm">Labeling Algorithm</a>).
AppProfiles are now the source of truth for profile-to-app mappings.
A new controller was introduced to reconcile not only AppProfiles,
but clusters and ApplicationSets as well since they are all inter linked.</p>
<h2 id="object-model">Object model<a class="headerlink" href="#object-model" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><em>Arlon Application</em> (or <em>App</em> for short): a thin wrapper around an ApplicationSet.
  An ApplicationSet is an Arlon Application if it has the <code>managed-by=arlon</code> label.</p>
</li>
<li>
<p><em>App Profile</em>: a uniquely named set of Arlon Applications. It is backed by a new custom resource and CRD.
  (The resource is named <strong>AppProfile</strong> to distinguish it from the gen1 <strong>Profile</strong> resource. Even though
  gen1 profiles will deprecated and eventually retired, the naming scheme avoids conflicts during the transition).</p>
</li>
<li>
<p><em>Arlon Cluster</em>: a gen2 cluster created by Arlon.</p>
</li>
<li>As a reminder, it is represented by between 2 and 3 ArgoCD Application resources:<ul>
<li>The cluster application (named with the workload cluster name)</li>
<li>The arlon application (named by appending the -arlon suffix to the cluster application's name)</li>
<li>The optional profile application (named by appending -profile suffix to the cluster application's name)</li>
</ul>
</li>
<li>The first application (the cluster application) is treated as the anchor for the entire set. When an Arlon Cluster
    is associated with an AppProfile, the cluster application will be labeled with the AppProfile's name.</li>
<li>
<p>An Arlon Cluster that was successfully deployed always has an associated ArgoCD cluster (thanks to the ClusterRegistration mechanism).</p>
</li>
<li>
<p><em>ArgoCD Cluster</em>: the set of ArgoCD clusters is a superset of Arlon clusters.</p>
</li>
<li>
<p><em>External Cluster</em>: any ArgoCD cluster that was not created by Arlon.
  So essentially <code>External Clusters Set = ArgoCD Clusters Set - Arlon Clusters Set</code>.
  A user may want to associate an external cluster with an app profile.</p>
</li>
</ul>
<p>Observations:
- An app profile can be associated with (or "contain") any number of applications
- And an app can be associated with multiple profiles.
- A cluster is said to be associated with a profile if it is labeled with <code>arlon.io/profile=&lt;profileName&gt;</code>.
- A cluster can be associated with <strong>at most one</strong> profile. A profile may be associated (attached to) any number of clusters.</p>
<p>This table summarizes the actual resources backing the objects:
| Object Type        | Actual Resource        |
|--------------------|------------------------|
| Arlon Application  | ArgoCD ApplicationSet  |
| AppProfile         | AppProfile             |
| Arlon Cluster      | ArgoCD Application     |
| ArgoCD Cluster     | Kubernetes Secret      |</p>
<h2 id="labeling-algorithm">Labeling Algorithm<a class="headerlink" href="#labeling-algorithm" title="Permanent link">&para;</a></h2>
<p>Just like in proposal 1, associating a cluster with an app profile is done by labeling the cluster
with the profile's name, and ensuring that that name is included in the corresponding ApplicationSet's
<code>matchExpressions</code> values list. But there are some differences:
- For an Arlon cluster, which is anchored by an ArgoCD Application resource,
  the user should label the Application resource, not the corresponding ArgoCD cluster.
  The new AppProfile controller will propagate the label to the corresponding ArgoCD cluster.
  This allows the user to deploy an Arlon cluster, create and populate a profile, and associate
  the cluster to the profile all in one declarative "apply" operation. (A user can't label
  an ArgoCD cluster that doesn't exist yet)
- For non-Arlon clusters, generally referred as "external", the design allows those existing
  ArgoCD clusters to be labeled directly, but this will be managed outside of the AppProfiles controller
  and essentially the user's responsibility, and has limitations.</p>
<h2 id="controller">Controller<a class="headerlink" href="#controller" title="Permanent link">&para;</a></h2>
<p>A new controller was developed to not only reconcile AppProfiles, but also clusters and ApplicationSets
(those representing Arlon Applications) since they are now all inter linked through profiles.
- The main controller logic resides in <code>pkg/appprofile/reconcile.go</code> and <code>controllers/appprofile_controller.go</code>.
- Additionally, logic was added to reconcile ArgoCD applications (representing Arlon clusters) and
  ArgoCD ApplicationSets (representing Arlon apps) with the relationships defined by AppProfiles:
  - <code>controllers/application_controller.go</code>
  - <code>controllers/applicationset_controller.go</code>
- The new logic will be eventually merged into the main controller. In the prototype, it is available as a separate CLI command
  to simplify testing: <code>arlon appprofile-controller</code>.
The reconciliation algorithm is complex due to the number of interdependent resources.
See <a href="#Appendix-A-Reconciliation-Algorithm">Appendix A: Reconciliation Algorithm</a> for details.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>Since all objects direcly map to Kubernetes resources, the user can in theory manage everything
with <code>kubectl [create/apply/edit/delete/lebel]</code>. However, the arlon CLI and API are still useful
for some things as explained below.</p>
<h3 id="creating-an-initial-arlon-application">Creating an initial Arlon Application<a class="headerlink" href="#creating-an-initial-arlon-application" title="Permanent link">&para;</a></h3>
<p>Even though an Arlon app is directly represented by an ApplicationSet, the resource has strict
requirements, so it's easiest to create it with the help of the future <code>arlon app create</code>, which can
create the resource directly or dump its YAML to standard out. (This command is not yet implemented
in the initial Proposal 2 prototype).</p>
<p>The requirements on the ApplicationSet are:
- Must have the <code>arlon-type=application</code> label.
- The spec's <code>generators</code> section must use a single generator with a <code>matchExpressions</code> selector with
  the <code>arlon.io/profile</code> key and <code>In</code> as operator.  (Note: the <code>values</code> field will later be
  set the AppProfile controller, automatically)
- The spec's <code>template</code> section must templatize the generated ArgoCD application names
  based on the workload cluster name. The user is free to configure the template's
  <code>spec</code> subsection to target any manifest or Helm chart in git.</p>
<p>Example:
<div class="highlight"><pre><span></span><code>apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  labels:
    arlon-type: application
  name: guestbook
  namespace: argocd
spec:
  generators:
  - clusters:
      selector:
        matchExpressions:
        - key: arlon.io/profile
          operator: In
          values: []
  template:
    metadata:
      name: &#39;{{name}}-appset-guestbook&#39;
    spec:
      destination:
        namespace: default
        server: &#39;{{server}}&#39;
      project: default
      source:
        path: guestbook
        repoURL: https://github.com/argoproj/argocd-example-apps/
        targetRevision: HEAD
      syncPolicy:
        automated:
          prune: true
</code></pre></div></p>
<h3 id="managing-application-profiles">Managing Application Profiles<a class="headerlink" href="#managing-application-profiles" title="Permanent link">&para;</a></h3>
<p>An AppProfile is a new custom resource with a simple spec: a list of Arlon Application names:
<div class="highlight"><pre><span></span><code>apiVersion: core.arlon.io/v1
kind: AppProfile
metadata:
  name: engineering
  namespace: arlon
spec:
  appNames:
  - guestbook
  - wordpress
  - nginx
status:
  health: degraded
  invalidAppNames:
  - wordpress
  - nginx
</code></pre></div></p>
<ul>
<li>The resource also has a Status field that the controller updates.</li>
<li>The <code>Status.health</code> subfield is either <code>healthy</code> or <code>degraded</code>. Degraded means that one or more specified apps don't exist.</li>
<li>The <code>Status.invalidAppNames</code> indicates which app names are invalid, if any.</li>
</ul>
<p>The presence of the <code>Status</code> section is a result of the decision to validate the profile asynchronously and allow invalid app
names to be specified. This generally results in a simpler design, and follows the Kubernetes philosophy of allowing a user
to specify any <code>spec</code> and report status later, after reconciliation. The alternative would have been to validate the app names
synchronously using a webhook. This alternative was not currently chosen due to the complexity of webhook devopment and testing,
but may be reconsidered in the future if a good use case arises.</p>
<ul>
<li>Updating a profile's <code>Spec.appNames</code> can have immediate side effects:
  corresponding ArgoCD Applications can be deployed or destroyed in any clusters labeled with the profile name,
  as soon as the controller finishes reconciliation.</li>
<li>To list profiles: <code>kubectl -n arlon get appprofiles</code></li>
<li>To delete a profile: <code>kubectl -n arlon delete appprofile &lt;name&gt;</code>. As expected, this command can have immediate effects on impacted clusters.</li>
</ul>
<h3 id="associating-profiles-with-arlon-clusters">Associating profiles with Arlon clusters<a class="headerlink" href="#associating-profiles-with-arlon-clusters" title="Permanent link">&para;</a></h3>
<p>A cluster can have at most one profile attached to it. The labeling mechanism can be viewed as an internal
Arlon implementation detail, and it will be hidden from users with <code>arlon</code> CLI providing commands to
attach/detach profiles to/from clusters,
but until that's implemented, the user can achieve the same effect by using Kubernetes labeling directly:</p>
<ul>
<li>To attach a profile to an Arlon cluster, simply label the corresponding anchor ArgoCD Application as follows:</li>
<li><code>kubectl -n argocd label application --overwrite &lt;clusterName&gt; arlon.io/profile=&lt;profileName&gt;</code></li>
<li>To detach, remove the label:</li>
<li><code>kubectl -n argocd label application &lt;clusterName&gt; arlon.io/profile-</code></li>
</ul>
<p>In addition to those raw kubectl commands, we propose to add arlon CLI commands and APIs to slightly simplify the task
and abstract out the labeling.</p>
<h3 id="associating-profiles-with-external-clusters-experimental-not-tested-yet">Associating profiles with external clusters (experimental, not tested yet)<a class="headerlink" href="#associating-profiles-with-external-clusters-experimental-not-tested-yet" title="Permanent link">&para;</a></h3>
<p>An external cluster does not have an Arlon representation (meaning there is no "anchor" ArgoCD Application with the same name).
It can still be associated with an AppProfile by labeling the raw ArgoCD cluster:
- Unfortunately as of ArgoCD 2.4, there is no argocd CLI command to label a cluster
- A user can still manually label the <strong>secret</strong> resource where ArgoCD stores the cluster's metadata and credentials. This requires some work,
  as those secrets are named using an non-obvious convention.
- The best thing Arlon should do is to provide dedicated CLI commands and APIs to simplify this task.</p>
<h2 id="fully-declarative-initialization">Fully declarative initialization<a class="headerlink" href="#fully-declarative-initialization" title="Permanent link">&para;</a></h2>
<p>Now that all Arlon concepts are represented by declarative resources, it is now possible to provision a complete set of resources
with a single <code>kubectl apply -f</code> on a file or folder of manifests. In particular, we can now develop a fully self-contained
demo folder that contains all of these resources containing references to each other:
- App Profiles
- Apps
- Arlon Clusters</p>
<p>The user can then <code>kubectl apply -f</code> the whole folder and observe the automatic creation of the cluster(s), profiles, and apps.</p>
<p>(Note: the workload clusters need a cluster template in git. This can be supplied by the Arlon repo itself. This does point to
an issue that may become a problem later on: cluster templates don't have a representation today. There is no registration
mechanism for them. The user is expected to "know" where his/her cluster templates reside, and is responsible for specifying
their git location when creating new workload clusters)</p>
<h2 id="application-overrides">Application Overrides<a class="headerlink" href="#application-overrides" title="Permanent link">&para;</a></h2>
<p>Given that an Arlon Application is just a specialized ApplicationSet, it inherits an ApplicationSet's
ability to specify a full ArgoCD Application spec, and this spec can contain overrides for Helm charts.
- This does mean that every different permutation of override values requires a new ApplicationSet, and therefore Arlon Application.
- This may be reasonable if we accept that an Arlon Application is not a true application, but rather, an intermediate object that points
  to the true application source residing in Git. The intermediate object can be viewed as a customization or specialization of the
  application source, so it's ok to have multiple intermediate objects, each holding a different set of customizations.</p>
<h2 id="issues-limitations">Issues &amp; Limitations<a class="headerlink" href="#issues-limitations" title="Permanent link">&para;</a></h2>
<p>The remaining issues &amp; limitations raised in Proposal 1 still apply:
- Only one profile per cluster
- Inherits any limitations of ApplicationSets
- Does not support ApplicationSets with other types of generators
- Makes Arlon even more dependent on ArgoCD technology
- There is no way to create a per-cluster application override, unless the user creates a unique and dedicated Arlon Application for
  the cluster, places it in a dedicated profile, and applies the profile to the cluster.</p>
<h2 id="appendix-a-reconciliation-algorithm">Appendix A: Reconciliation Algorithm<a class="headerlink" href="#appendix-a-reconciliation-algorithm" title="Permanent link">&para;</a></h2>
<p>The pseudocode looks something like:</p>
<p><img alt="image" src="../arlon-gen2-profiles-reconc-algo.png" /></p>





                
  

              </article>
            </div>
          
          
        </div>
        
      </main>
      
        

<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        with emoji by
        <a href="https://github.com/twitter/twemoji" target="_blank" rel="noopener">
          Twemoji
        </a>
      </div>
      <div class="md-social">
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.8.4/dist/mermaid.min.js"></script>
      
        <script src="../assets/pymdownx-extras/extra-loader-52693605.js"></script>
      
    
  </body>
</html>