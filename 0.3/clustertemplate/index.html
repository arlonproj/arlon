
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../images/favicon-32x32.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Cluster template - Arlon - GitOps-based Fleet Management for Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    

<script src="../assets/pymdownx-extras/material-extra-theme-8d50d708.js" type="text/javascript"></script>
<script src="../assets/pymdownx-extras/material-extra-3rdparty-a81e7739.js" type="text/javascript"></script>

    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Work Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../assets/pymdownx-extras/extra-34c51d7bc1.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#next-gen-cluster-provisioning-using-cluster-templates" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      


<header class="md-header" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >
    <a
      href=".."
      title="Arlon - GitOps-based Fleet Management for Kubernetes"
      class="md-header__button md-logo"
      aria-label="Arlon - GitOps-based Fleet Management for Kubernetes"
    >
      
  <img src="../images/pictogram_arlon-stroke.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Arlon - GitOps-based Fleet Management for Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cluster template
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon">
          <a
            href="javascript:toggleScheme();"
            title="Light mode"
            class="light-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="Dark mode"
            class="dark-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
          </a>
          <a
            href="javascript:toggleScheme();"
            title="System preference"
            class="system-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34Z"/></svg>
          </a>
           <a
            href="javascript:toggleScheme();"
            title="Unknown scheme"
            class="unknown-mode"
          >
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10Z"/></svg>
          </a>
      </div>
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/arlonproj/arlon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    arlonproj/arlon
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Arlon - GitOps-based Fleet Management for Kubernetes" class="md-nav__button md-logo" aria-label="Arlon - GitOps-based Fleet Management for Kubernetes" data-md-component="logo">
      
  <img src="../images/pictogram_arlon-stroke.svg" alt="logo">

    </a>
    Arlon - GitOps-based Fleet Management for Kubernetes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/arlonproj/arlon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    arlonproj/arlon
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Cluster template
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Cluster template
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    Goals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profile-support" class="md-nav__link">
    Profile support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    Architecture diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-template" class="md-nav__link">
    Cluster Template
  </a>
  
    <nav class="md-nav" aria-label="Cluster Template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workload-clusters" class="md-nav__link">
    Workload clusters
  </a>
  
    <nav class="md-nav" aria-label="Workload clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creation" class="md-nav__link">
    Creation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composition" class="md-nav__link">
    Composition
  </a>
  
    <nav class="md-nav" aria-label="Composition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster-app" class="md-nav__link">
    Cluster app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arlon-app" class="md-nav__link">
    Arlon app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-app-optional" class="md-nav__link">
    Profile app (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#update-semantics" class="md-nav__link">
    Update Semantics
  </a>
  
    <nav class="md-nav" aria-label="Update Semantics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsupported-changes" class="md-nav__link">
    Unsupported changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        Design
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gen2_Tutorial/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Developer Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dev_setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../e2e_testing/" class="md-nav__link">
        End to End Tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../docs_help/" class="md-nav__link">
        Help with MkDocs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    Goals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profile-support" class="md-nav__link">
    Profile support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-diagram" class="md-nav__link">
    Architecture diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-template" class="md-nav__link">
    Cluster Template
  </a>
  
    <nav class="md-nav" aria-label="Cluster Template">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workload-clusters" class="md-nav__link">
    Workload clusters
  </a>
  
    <nav class="md-nav" aria-label="Workload clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creation" class="md-nav__link">
    Creation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composition" class="md-nav__link">
    Composition
  </a>
  
    <nav class="md-nav" aria-label="Composition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster-app" class="md-nav__link">
    Cluster app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arlon-app" class="md-nav__link">
    Arlon app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-app-optional" class="md-nav__link">
    Profile app (optional)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#update-semantics" class="md-nav__link">
    Update Semantics
  </a>
  
    <nav class="md-nav" aria-label="Update Semantics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsupported-changes" class="md-nav__link">
    Unsupported changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  

  <a href="https://github.com/arlonproj/arlon/edit/main/docs/clustertemplate.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="next-gen-cluster-provisioning-using-cluster-templates">Next-gen Cluster Provisioning using Cluster templates<a class="headerlink" href="#next-gen-cluster-provisioning-using-cluster-templates" title="Permanent link">&para;</a></h1>
<p>This document describes a new way of provisioning workload clusters in Arlon.
The most significant change is the <em>Cluster Template</em> construct, which replaces the older ClusterSpec from gen1 clusters.
To distinguish them from the older gen1 clusters, the ones deployed from a cluster template are called next-gen clusters or gen2 clusters.</p>
<h2 id="goals">Goals<a class="headerlink" href="#goals" title="Permanent link">&para;</a></h2>
<ul>
<li>Allow users to deploy arbitrarily complex clusters using the full Cluster API feature set.</li>
<li>Fully declarative and gitops compatible: a cluster deployment should be composed of one or more self-sufficient manifests that the user can choose to either apply directly (via kubectl) or store in git for later-stage deployment by a gitops tool (mainly ArgoCD).</li>
<li>Support Linked Mode update: an update to the the cluster template should
automatically propagate to all workload clusters deployed from it.</li>
</ul>
<h2 id="profile-support">Profile support<a class="headerlink" href="#profile-support" title="Permanent link">&para;</a></h2>
<ul>
<li>While profiles are also being re-architected, the first implementation of next-gen clusters fully integrates with current-generation profiles, which are expressed as Profile custom resources and compiled into a set of intermediate files in a git repository.</li>
<li>Profiles are optional, and a next-gen cluster can be created without a profile.
One can be attached later.</li>
</ul>
<h2 id="architecture-diagram">Architecture diagram<a class="headerlink" href="#architecture-diagram" title="Permanent link">&para;</a></h2>
<p>This example shows a cluster template named <code>capi-quickstart</code> used to deploy two workload clusters <code>cluster-a</code> and <code>cluster-b</code>. Additionally, <code>cluster-a</code> is given profile <code>xxx</code>, while <code>cluster-b</code> is given profile <code>yyy</code>.</p>
<p><img alt="architecture" src="../images/arlon_gen2.png" /></p>
<h2 id="cluster-template">Cluster Template<a class="headerlink" href="#cluster-template" title="Permanent link">&para;</a></h2>
<p>A cluster template serves as a base for creating new workload clusters. The workload clusters are all exact copies of the cluster template, meaning that they acquire all unmodified resources of the cluster template, except for:</p>
<ul>
<li>resource names, which are prefixed during the cluster creation process to make them unique to avoid conflicts</li>
<li>the namespace, which is set to a new namespace unique to the workload cluster</li>
</ul>
<h3 id="preparation">Preparation<a class="headerlink" href="#preparation" title="Permanent link">&para;</a></h3>
<ul>
<li>To create a cluster template, a user first creates a single YAML file containing the desired Cluster API cluster and all related resources (e.g. MachineDeployments, etc...), using whatever tool the user chooses (e.g. <code>clusterctl generate cluster</code>). The user is responsible for the correctness of the file and resources within. Arlon will not check for errors. For example, the specified Kubernetes version must be supported by the Cluster API providers currently installed in the management cluster. If it isn't, resulting clusters will fail and enter a perpetual OutOfSync state.</li>
<li>The user then commits and pushes the manifest file to a dedicated directory in a git repository.
The name of the cluster resource does not matter, it will be used as a suffix during workload cluster creation. The directory should be unique to the file, and not contain any other files.</li>
<li>If not already registered, the git repository should also be registered in ArgoCD with the proper credentials for read/write access.</li>
</ul>
<p>To check whether the git directory is a compliant Arlon cluster template,
the user runs:</p>
<div class="highlight"><pre><span></span><code>arlon clustertemplate validategit --repo-url &lt;repoUrl&gt; --repo-path &lt;pathToDirectory&gt; <span class="o">[</span>--repo-revision revision<span class="o">]</span>  
</code></pre></div>
<p><em>Note: if --repo-revision is not specified, it defaults to main.</em></p>
<p>The command produces an error the first time because the git directory has not yet been "prepped".
To "prep" the directory to become a compliant Arlon cluster template, the user runs:</p>
<div class="highlight"><pre><span></span><code>arlon clustertemplate preparegit --repo-url &lt;repoUrl&gt; --repo-path &lt;pathToDirectory&gt; <span class="o">[</span>--repo-revision revision<span class="o">]</span>  
</code></pre></div>
<p>This pushes a commit to the repo with these changes:</p>
<ul>
<li>A <code>kustomization.yaml</code> file is added to the directory to make the manifest customizable by Kustomize.</li>
<li>A <code>configurations.yaml</code> file is added to configure the <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/transformerconfigs/README.md#name-reference-transformer">namereference</a> Kustomize plugin which ensures <code>reference</code> fields are correctly set when pointing to resource names that ArgoCD will modify using the Kustomize <a href="https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/nameprefix/">nameprefix</a>
mechanism. The content of the file is sourced from this <a href="https://blog.scottlowe.org/2021/10/11/kustomize-transformer-configurations-for-cluster-api-v1beta1/">Scott Lowe blog article</a>.</li>
<li>All <code>namespace</code> properties in the cluster manifest are removed to allow Kustomize to override the namespace of all resources.</li>
</ul>
<p>If prep is successful, another invocation of <code>arlon clustertemplate validategit</code> should succeed as well.</p>
<h2 id="workload-clusters">Workload clusters<a class="headerlink" href="#workload-clusters" title="Permanent link">&para;</a></h2>
<h3 id="creation">Creation<a class="headerlink" href="#creation" title="Permanent link">&para;</a></h3>
<p>Use <code>arlon cluster create</code> to create a next-gen workload cluster from a cluster template
(<em>this is different from</em> <code>arlon cluster deploy</code> <em>for creating older gen1 clusters</em>).
The command creates between 2 and 3 (depending on whether a profile is used)
ArgoCD application resources that together make up the cluster and its contents. The general usage is:</p>
<div class="highlight"><pre><span></span><code>arlon cluster create --cluster-name &lt;clusterName&gt; --repo-url &lt;repoUrl&gt; --repo-path &lt;pathToDirectory&gt; <span class="o">[</span>--output-yaml<span class="o">]</span> <span class="o">[</span>--profile &lt;profileName&gt;<span class="o">]</span> <span class="o">[</span>--repo-revision &lt;repoRevision&gt;<span class="o">]</span>
</code></pre></div>
<p>The command supports two modes of operation:</p>
<ul>
<li>With <code>--output-yaml</code>: output a list of YAML resources that you can inspect, save to a file, or pipe to <code>kubectl apply -f</code></li>
<li>Without <code>--output-yaml</code>: create the application resources directly in the management cluster currently referenced by your KUBECONFIG and context.  </li>
</ul>
<p>The <code>--profile</code> flag is optional; a cluster can be created with no profile.</p>
<h3 id="composition">Composition<a class="headerlink" href="#composition" title="Permanent link">&para;</a></h3>
<p>A workload cluster is composed of 2 to 3 ArgoCD application resources, which are named based on the name of the cluster template and the workload cluster. For illustration purposes, the following discussion assumes that the cluster template is named <code>capi-quickstart</code>, the workload cluster is named <code>cluster-a</code>, and the optional profile is named <code>xxx</code>.</p>
<h4 id="cluster-app">Cluster app<a class="headerlink" href="#cluster-app" title="Permanent link">&para;</a></h4>
<p>The <code>cluster-a</code> application is the <em>cluster app</em> for the cluster.
It is responsible for deploying the cluster template resources, meaning the Cluster API manifests.
It is named directly from the workload cluster name.</p>
<p>The application's spec uses a ApplicationSourceKustomize that points to the cluster template's git directory. The spec ensures that all deployed resources are configured to:</p>
<ul>
<li>Reside in the <code>cluster-a</code> namespace, which is deployed by the <em>arlon app</em> (see below).
This achieved by setting <code>app.Spec.Destination.Namespace</code> to the workload cluster's name
  (<em>this only works if the resources do not specify an explicit namespace</em>; this requirement is taken care of by the "prep" step on the <em>cluster template</em>).</li>
<li>Be named <code>cluster-a-capi-quickstart</code>, meaning the workload cluster name followed by the cluster template name. This is achieved by setting <code>app.Spec.Source.Kustomize.NamePrefix</code> to the workload cluster name plus a hyphen.</li>
</ul>
<h4 id="arlon-app">Arlon app<a class="headerlink" href="#arlon-app" title="Permanent link">&para;</a></h4>
<p>The <code>cluster-a-arlon</code> application is the <em>arlon app</em> for the cluster.
It is resposible for deploying:</p>
<ul>
<li>The <code>cluster-a</code> namespace, which holds most resources related to this workload cluster, such as the Cluster API manifests deployed by the cluster app.</li>
<li>Resources required to register the workload cluster with argocd when available:
ClusterRegistration and associated RBAC rules.</li>
<li>Additional resources (service account, more RBAC rules) for Cluster Autoscaler if enabled.</li>
</ul>
<p>The application spec's ApplicationSource points to the existing Arlon Helm chart
located here by default:</p>
<ul>
<li>Repo: <a href="https://github.com/arlonproj/arlon.git">https://github.com/arlonproj/arlon.git</a></li>
<li>Revision: private/leb/gen2 (IMPORTANT: NEEDS TO CHANGE TO STABLE BRANCH OR TAG)</li>
<li>Path: pkg/cluster/manifests</li>
</ul>
<p>This is the same Helm chart that gen1 clusters using <code>arlon cluster deploy</code> are deployed from.
When used for the arlon app for a gen2 cluster, the Helm parameters are configured to only deploy the Arlon resources, with the subchart for cluster resources disabled, since those resources will be deployed by the cluster app.</p>
<p><strong>Important issue</strong>: as described above, the application source resides in the public Arlon repo.
To avoid breaking user's deployed clusters, the source must be stable and not change!</p>
<ul>
<li>This probably means a particular Arlon release should point the source to a stable tag (not even a branch?)</li>
<li>As an alternative, during Arlon setup, allow the user to copy the Helm chart into a private repo, and point the source there.</li>
</ul>
<h4 id="profile-app-optional">Profile app (optional)<a class="headerlink" href="#profile-app-optional" title="Permanent link">&para;</a></h4>
<p>A next-gen cluster can be assigned a current-gen dynamic profile, in which case Arlon creates
a <em>profile app</em> named <code>&lt;clusterName&gt;-profile-&lt;profileName&gt;</code>, or <code>cluster-a-profile-xxx</code> in the running example.</p>
<p>This is similar to the profile app created when attaching a profile app to an external cluster.
The application source points to the git location of the dynamic profile.</p>
<h3 id="teardown">Teardown<a class="headerlink" href="#teardown" title="Permanent link">&para;</a></h3>
<p>Since a next-gen cluster is composed of multiple ArgoCD applications, destroying the cluster requires deleting all of its applications. To facilitate this, the 2 or 3 applications created by <code>arlon cluster create</code> are automatically labeled with <code>arlon-cluster=&lt;clusterName&gt;</code>.</p>
<p>The user has two options for destroying a next-gen cluster:</p>
<ul>
<li>The easiest way: <code>arlon cluster delete &lt;clusterName&gt;</code>. This command automatically detects a next-gen cluster and cleans up all related applications.</li>
<li>A more manual way: <code>kubectl delete application -l arlon-cluster=&lt;clusterName&gt;</code></li>
</ul>
<h2 id="update-semantics">Update Semantics<a class="headerlink" href="#update-semantics" title="Permanent link">&para;</a></h2>
<p>A cluster template lives in git and is shared by all workload clusters created from it.
This is sometimes referred to as <em>Linked Mode</em>.
Any git update to the cluster can affect the associated workload clusters, therefore such updates must be planned and managed with care; there is a real risk of such an update breaking existing clusters.</p>
<ul>
<li>By default, a workload's cluster <em>cluster app</em> is configured with auto-sync, meaning ArgoCD will immediately apply any changes in the cluster template to the deployed Cluster API cluster resources.</li>
<li>In general, a cluster template <strong>does not need to be "prepped" again</strong> after a modification to its main manifest file (the one containing the Cluster API resources). So the user is free to edit the manifest directly, commit/push the changes, and expect to see immediate changes to already-deployed clusters
created from that cluster template.</li>
</ul>
<h3 id="unsupported-changes">Unsupported changes<a class="headerlink" href="#unsupported-changes" title="Permanent link">&para;</a></h3>
<p>The controllers for Cluster API and its providers disallow changes to some fields belonging to already-deployed resources.</p>
<ul>
<li>For example, changing the cluster template name (<code>medata.Name</code> of the <code>Cluster</code> resource) will have disastrous consequences on already-deployed
clusters, causing many resources to enter the OutOfSync state and never recover because ArgoCD fails to apply the changes (they are rejected by the controllers). Consequently, a user should never change the name of a cluster template.</li>
<li>Besides the cluster name, other fields cannot change (this has been observed anecdotally, we don't yet have an exhaustive list).</li>
<li>Changing the Kubernetes version of the control plane or data plane <em>is</em> supported, so long as the new version is supported by the relevant providers. If accepted, such a change will result in a rolling update of the corresponding plane.</li>
<li>Specific to AWS: the <code>AWSMachineTemplate.spec</code> is immutable and a CAPI webhook disallows such updates. The user is advised to not make such modifications to a cluster template manifest.
In the event that such an event does happen, the user is advised to not manually sync in those changes via <code>argocd</code>. If a new cluster with a different <code>AWSMachineTemplate.spec</code> is desired,
the recommended approach is to make a copy of the manifests in the workspace repository and then issue an <code>arlon cluster create</code> command which would then consume this manifest.</li>
</ul>





                
  

              </article>
            </div>
          
          
        </div>
        
      </main>
      
        

<footer class="md-footer">
  
    <nav
      class="md-footer__inner md-grid"
      aria-label="Footer"
    >
      
        <a
          href="../concepts/"
          class="md-footer__link md-footer__link--prev"
          rel="prev"
        >
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Concepts
            </div>
          </div>
        </a>
      
      
        <a
          href="../design/"
          class="md-footer__link md-footer__link--next"
          rel="next"
        >
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Design
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        with emoji by
        <a href="https://github.com/twitter/twemoji" target="_blank" rel="noopener">
          Twemoji
        </a>
      </div>
      <div class="md-social">
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.8.4/dist/mermaid.min.js"></script>
      
        <script src="../assets/pymdownx-extras/extra-loader-52693605.js"></script>
      
    
    
  </body>
</html>